<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>mTouch Framework: Proximity Sensors</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="main.html">main</a>      </li>
      <li><a class="el" href="_framework_features.html">Features</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Proximity Sensors </h1>  </div>
</div>
<div class="contents">
<p>The mTouch Framework supports proximity detection sensors. Enabling this feature for a sensor will provide a higher signal-to-noise ratio by applying a median filter. Future updates may further enhance this capability. The API for handling the proximity sensor is exactly the same as with a normal sensor.</p>
<h2><a class="anchor" id="featProx-How"></a>
How It Works</h2>
<p>The theory of operation for proximity sensors is the same as touch buttons and keys. However, proximity sensors must be able to detect very small changes in capacitance, so a median filter is implemented to reduce the noise level. The largest cost of implementing this feature is the RAM requirement since we must store the previous N samples for the median filter. This also means the response time will be longer than for a normal sensor while the median filter updates.</p>
<p>The basic idea of a median filter is that it stores a history of the previous scan results in a first-in, first-out buffer. After each new scan, the oldest value is replaced with the newest, the array is sorted by size, and the middle values are averaged.</p>
<div align="center">
<img src="medianFilter.jpg" alt="medianFilter.jpg"/>
<p><strong>Median Filter Illustration</strong></p></div>
 <h2><a class="anchor" id="featProx-Config"></a>
Proximity Sensor Configuration</h2>
<ol>
<li>
Configure the proximity sensor(s) to be scanned as normal sensors in the <a class="el" href="m_touch__config_8h.html" title="Framework Configuration! Main configuration file for the mTouch Framework.">mTouch_config.h</a> file. The differences are that you may need to set a larger oversampling value and a lower threshold value to make the sensor more sensitive. The threshold, unlike for button sensors, should not be set by evaluating the maximum touch shift. Instead, set it by observing the maximum noise level. Using the two-way communications with the mTouch Two-Way GUI is an easy way to adjust these values.<br/>
 You can find the mTouch Two-Way GUI in <code>Your MLA Directory/mTouchCapDemos/Utilities/PIC12F PIC16F Utilities/mTouch Two-Way GUI</code> </li>
<li>
At the bottom of <a class="el" href="m_touch__config_8h.html" title="Framework Configuration! Main configuration file for the mTouch Framework.">mTouch_config.h</a> is the 'Proximity' configuration section. <ol type="a">
<li>
Set <a class="el" href="group___configuration.html#gab0cd572ad79154916b8a55c60eff7afe" title="Defines how many proximity sensors are activated.">MTOUCH_NUMBER_PROXIMITY</a> to the total number of proximity sensors in your system. </li>
<li>
Define one MTOUCH_SENSORx_IS_PROX definition per enabled proximity sensor. The value of the definition must be its 'proximity index' value. The 'Proximity index' is used as the index to proximity variable arrays. In total, the indexes should start at 0 and end with MTOUCH_NUMBER_PROXIMITY - 1. The order is arbitrary. <div class="fragment"><pre class="fragment"><span class="preprocessor">   #define MTOUCH_NUMBER_PROXIMITY     1          </span>
<span class="preprocessor">   #define MTOUCH_SENSOR3_IS_PROX      0   // MTOUCH_SENSOR3 is a proximity sensor with index 0   </span>
</pre></div> <div class="fragment"><pre class="fragment"><span class="preprocessor">   #define MTOUCH_NUMBER_PROXIMITY     2          </span>
<span class="preprocessor"></span><span class="preprocessor">   #define MTOUCH_SENSOR4_IS_PROX      0   // MTOUCH_SENSOR4 is a proximity sensor with index 0          </span>
<span class="preprocessor">   #define MTOUCH_SENSOR9_IS_PROX      1   // MTOUCH_SENSOR9 is a proximity sensor with index 1</span>
</pre></div> </li>
<li>
Set the parameters for the median filter: <ul>
<li>
<a class="el" href="group___configuration.html#gaf70ecd7586cfcab84907d775eff718b0" title="Determines the size of the buffer used in the proximity median filter.">MTOUCH_PROX_BUFFER_SIZE</a> decides the size of the buffer for the median filter. Each proximity sensor will have its own median filter array, so be careful when assigning this value as it will have significant effects on the RAM requirements of the proximity implementation. Valid options are 5, 9, and 15. Larger number means more filtering, but higher RAM requirements and slower response times. </li>
<li>
<a class="el" href="group___configuration.html#ga059ab17678eb7f02db27fe346c42e919" title="The median filter&#39;s N largest and N smallest values are not included in the filter&#39;s output v...">MTOUCH_PROX_REMOVE_EXTREME</a> determines how many of the largest and smallest numbers will be removed before averaging the middle values. For example, if we are filtering with a buffer size of 5 and this value is set to 1, we will average the 2nd, 3rd, and 4th values. With a buffer size of 9 and this value set to 2, we will average the 3rd, 4th, 5th, 6th, and 7th values. This value must be less than half the buffer size and greater than 0. </li>
<li>
Enable (recommended) or disable the <a class="el" href="group___configuration.html#gaee1525da9896f5f850c6a14d451f0817" title="If defined, the accumulator used during the decoding process of the proximity sensor will be implemen...">MTOUCH_PROX_USE_32BIT_ACCUM</a> option based on your proximity sensor's output data. Enabling this will prevent math overflow errors when the buffer is being accumulated, but will add to the overall RAM requirement. It's possible you will not need this protection, depending on the configuration, so this has been provided to easily allow toggling between the two. (Example when you don't need the accumulator: buffer size of '5' and remove extreme value of '2'. No accumulation occurs: the middle value is taken as-is.) </li>
</ul>
</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="featProx-Ex"></a>
Example</h2>
<div class="fragment"><pre class="fragment"><span class="preprocessor"> #define MTOUCH_NUMBER_PROXIMITY       2   // Two proximity sensors</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_SENSOR0_IS_PROX        0   // MTOUCH_SENSOR0 is a proximity sensor with index 0</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_SENSOR5_IS_PROX        1   // MTOUCH_SENSOR5 is a proximity sensor with index 1</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_PROX_BUFFER_SIZE       5   // Median filter stores the last 5 values of each proximity sensor</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_PROX_REMOVE_EXTREME    1   // Removes the largest and smallest values before averaging</span>
<span class="preprocessor"> #define MTOUCH_PROX_USE_32BIT_ACCUM       // Uses a 32-bit accumulator to prevent math overflow</span>
</pre></div><h2><a class="anchor" id="featProx-Out"></a>
Proximity Sensor Output</h2>
<p>The way to access proximity sensor states is the same as for a normal sensor - using <a class="el" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState(i)</a>. The index, i, is the normal sensor index - not the proximity index. For example, in the above code we could check the state of the proximity sensors by using <a class="el" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState(0)</a> and <a class="el" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState(5)</a>. </p>
</div>
<hr class="footer"/><address class="footer"><small>mTouch Framework v2.3 documentation by&#160;
<a href="http://www.microchip.com"> 
<img class="footer" src="../includes/mchp.jpeg" alt="Click here to visit our website at www.microchip.com"/></a></small></address> 
</body> 
</html> 
