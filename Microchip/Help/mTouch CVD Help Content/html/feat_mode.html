<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>mTouch Framework: Scanning Modes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="main.html">main</a>      </li>
      <li><a class="el" href="_framework_features.html">Features</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Scanning Modes </h1>  </div>
</div>
<div class="contents">
<p>Scanning modes allow for an easy way to configure different states for the application where different sensors can be scanned in each state. For example, you could have a 'sleep' mode scanning a single proximity sensor and an 'active' mode that scans all sensors. You could then alternate between the states based on recent user activity to reduce power consumption.</p>
<p>When switching modes, the first scan result is ignored to allow the filters to properly reset themselves. The mTouch_state.skippedDecode bit will be set if this occured with the most recent decode and should be used to limit when mode changes can occur. An example is provided below.</p>
<h2><a class="anchor" id="featMode-How"></a>
How It Works</h2>
<p>All mTouch sensors, regardless of which mode they are in, are first defined as a normal mTouch sensor in the <a class="el" href="m_touch__config_8h.html" title="Framework Configuration! Main configuration file for the mTouch Framework.">mTouch_config.h</a> file. The MTOUCH_SENSORx index value for the sensor will be used to configure the modes.</p>
<p>The MTOUCH_SENSORx index value will be referred to as the "sensor index".</p>
<p>You can define up to 10 different modes. Each mode must have at least one sensor being scanned. (If you wish to simply disable scanning, use the <a class="el" href="m_touch_8h.html#ad3bdf898f87de4107782514fe3fdfb09" title="Disables mTouch scanning.">mTouch_DisableScanning()</a> macro.) The framework will start in Mode0. All decisions on when to change modes and why are left to the application. To change a mode, use the mTouch_ChangeMode(i) call, where i is the mode number.</p>
<p>The framework will only scan and decode the sensors that are enabled for the currently-active mode.</p>
<h2><a class="anchor" id="featMode-Config"></a>
Scanning Mode Configuration</h2>
<ol>
<li>
Configure all sensors for the system in <a class="el" href="m_touch__config_8h.html" title="Framework Configuration! Main configuration file for the mTouch Framework.">mTouch_config.h</a> as normal. </li>
<li>
Open <a class="el" href="m_touch__config__modes_8h.html" title="Framework Configuration! Scanning mode options.">mTouch_config_modes.h</a> and set the value of MTOUCH_NUM_MODES to a value larger than 1. <ul>
<li>
(MTOUCH_NUM_MODES == 1) or (MTOUCH_NUM_MODES == 0) means 'modes' will not be implemented. </li>
</ul>
<div class="fragment"><pre class="fragment"><span class="preprocessor"> #define MTOUCH_NUM_MODES                    2   // Two modes: Mode0 and Mode1</span>
</pre></div> </li>
<li>
For each mode: <ul>
<li>
Set MTOUCH_MODEx_NUM_SENSORS to the number of sensors that will be scanned in that mode. <div class="fragment"><pre class="fragment"><span class="preprocessor"> #define MTOUCH_MODE0_NUM_SENSORS      3   // Three sensors scanned in Mode0.</span>
</pre></div> </li>
<li>
For each sensor in each mode: <ul>
<li>
Set MTOUCH_MODEx_SENSORx to the sensor index to be scanned. <div class="fragment"><pre class="fragment"><span class="preprocessor"> #define MTOUCH_MODE0_SENSOR0    4   // Sensor0 of Mode0 is MTOUCH_SENSOR4</span>
</pre></div> </li>
</ul>
</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="featMode-Ex"></a>
Scanning Mode Configuration Example</h2>
<div class="fragment"><pre class="fragment"> <span class="comment">//</span>
 <span class="comment">// mTouch_config.h        ::</span>
 <span class="comment">//</span>
<span class="preprocessor"> #define MTOUCH_NUMBER_SENSORS         4   // Total of four mTouch sensors</span>
<span class="preprocessor"></span>
<span class="preprocessor"> #define MTOUCH_SENSOR0              AN4        </span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_SENSOR1              AN2            </span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_SENSOR2              AN7    </span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_SENSOR3              AN8  </span>
<span class="preprocessor"></span>
 <span class="comment">//</span>
 <span class="comment">// mTouch_config_modes.h  ::</span>
 <span class="comment">//</span>
<span class="preprocessor"> #define MTOUCH_NUM_MODES              3   // Three modes: Mode0, Mode1, Mode2</span>
<span class="preprocessor"></span>
<span class="preprocessor"> #define MTOUCH_MODE0_NUM_SENSORS      3   // Mode0 has 3 sensors</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_MODE0_SENSOR0          0   // Sensor0 of Mode0 is MTOUCH_SENSOR0</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_MODE0_SENSOR1          1   // Sensor1 of Mode0 is MTOUCH_SENSOR1</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_MODE0_SENSOR2          2   // Sensor2 of Mode0 is MTOUCH_SENSOR2</span>
<span class="preprocessor"></span>
<span class="preprocessor"> #define MTOUCH_MODE1_NUM_SENSORS      1   // Mode1 has 1 sensor</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_MODE1_SENSOR0          0   // Sensor0 of Mode1 is MTOUCH_SENSOR0</span>
<span class="preprocessor"></span>
<span class="preprocessor"> #define MTOUCH_MODE2_NUM_SENSORS      2   // Mode2 has 2 sensors</span>
<span class="preprocessor"></span><span class="preprocessor"> #define MTOUCH_MODE2_SENSOR0          2   // Sensor0 of Mode2 is MTOUCH_SENSOR2</span>
<span class="preprocessor"> #define MTOUCH_MODE2_SENSOR1          3   // Sensor1 of Mode2 is MTOUCH_SENSOR3</span>
</pre></div><h2><a class="anchor" id="featMode-Out"></a>
Scanning Mode API</h2>
<p>To change the current mode, use the mTouch_ChangeMode(i) macro.</p>
<p>To read the current mode, use mTouch_modeIndex. Do NOT change mTouch_modeIndex directly. Use the mTouch_ChangeMode macro!</p>
<p>When switching modes, the first scan result is ignored to allow the filters to properly reset themselves. The mTouch_state.skippedDecode bit will be set if this occured with the most recent decode and should be used to limit when mode changes can occur. An example is provided below.</p>
<p>An example usage of the API to switch between modes based on the state of different sensors: </p>
<div class="fragment"><pre class="fragment"> <a class="code" href="m_touch_8h.html#ad3bdf898f87de4107782514fe3fdfb09" title="Disables mTouch scanning.">mTouch_DisableScanning</a>();   <span class="comment">// Temporarily disable scanning while this logic completes</span>
 
 <span class="comment">// Are all of the current sensors initialized? If not, stay in the current mode and keep scanning until </span>
 <span class="comment">// they are. mTouch_state.areInitialized is a single-bit reserved for making temporary, local checks </span>
 <span class="comment">// such as this.</span>
 <a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.<a class="code" href="structm_touch___state.html#ab1320a2e9a938dad2a563147945e97f9" title="Temporary flag used in local functions for a variety of uses.">areInitialized</a> = 1;
 
 <span class="comment">// Assuming four enabled sensors...</span>
 <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(0) == <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2a8ac4e988fd74c22ff6e99ee854cc848f" title="Sensor is still initializing.">MTOUCH_INITIALIZING</a>) {   <a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.<a class="code" href="structm_touch___state.html#ab1320a2e9a938dad2a563147945e97f9" title="Temporary flag used in local functions for a variety of uses.">areInitialized</a> = 0;    }
 <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(1) == <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2a8ac4e988fd74c22ff6e99ee854cc848f" title="Sensor is still initializing.">MTOUCH_INITIALIZING</a>) {   <a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.<a class="code" href="structm_touch___state.html#ab1320a2e9a938dad2a563147945e97f9" title="Temporary flag used in local functions for a variety of uses.">areInitialized</a> = 0;    }
 <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(2) == <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2a8ac4e988fd74c22ff6e99ee854cc848f" title="Sensor is still initializing.">MTOUCH_INITIALIZING</a>) {   <a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.<a class="code" href="structm_touch___state.html#ab1320a2e9a938dad2a563147945e97f9" title="Temporary flag used in local functions for a variety of uses.">areInitialized</a> = 0;    }
 <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(3) == <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2a8ac4e988fd74c22ff6e99ee854cc848f" title="Sensor is still initializing.">MTOUCH_INITIALIZING</a>) {   <a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.<a class="code" href="structm_touch___state.html#ab1320a2e9a938dad2a563147945e97f9" title="Temporary flag used in local functions for a variety of uses.">areInitialized</a> = 0;    }
 <span class="comment">// NOTE: You&#39;ll want additional checks here for all sensors being currently scanned.</span>

 <span class="keywordflow">if</span> (<a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.<a class="code" href="structm_touch___state.html#ab1320a2e9a938dad2a563147945e97f9" title="Temporary flag used in local functions for a variety of uses.">areInitialized</a> &amp;&amp; !<a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.skippedDecode)   <span class="comment">// If we&#39;re not still initializing,</span>
 {                                                                 <span class="comment">// and we didn&#39;t skip the decode</span>
                                                                   <span class="comment">// due to just changing modes...</span>
     <span class="keywordflow">if</span> (mTouch_modeIndex == 0)                            <span class="comment">// Application Specific: When in Mode0, let&#39;s</span>
     {                                                     <span class="comment">//    change to Mode1 based on MTOUCH_SENSOR1.</span>
         <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(1) == <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2aed5b3f2b7065991010f45eb04759ef01" title="Sensor is currently pressed.">MTOUCH_PRESSED</a>)
         {
             <a class="code" href="m_touch_8h.html#a5c62bf914c0353b75955a34212c1faae">mTouch_ChangeMode</a>(1); 
         }
     }
     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mTouch_modeIndex == 1)                       <span class="comment">// Application Specific: When in Mode1, let&#39;s</span>
     {                                                     <span class="comment">//    sleep in-between decodes and change to</span>
                                                           <span class="comment">//    Mode0 based on MTOUCH_SENSOR0.</span>

<span class="preprocessor">         #if defined(MCOMM_ENABLED) &amp;&amp; defined(MCOMM_UART_HARDWARE_USED) </span>
<span class="preprocessor"></span>                                           <span class="comment">// If we are outputting data using a hardware UART...</span>
             <span class="keywordflow">while</span>(<a class="code" href="m_comm__config_8h.html#ab10a52ce51c0b4ee7d8266fbde651d71">MCOMM_UART_TXIF</a> == 0);  <span class="comment">// Finish all communications before entering sleep</span>
<span class="preprocessor">         #endif</span>
<span class="preprocessor"></span>         
         PIC_SWDTEN_ON();                  <span class="comment">// If using a software-enabled WDT, enable it now.</span>
         SLEEP();                          <span class="comment">// Sleep, if you want to.</span>
         NOP();                            <span class="comment">// One more instruction is executed before sleeping.</span>
         
         <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(0) == <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2aed5b3f2b7065991010f45eb04759ef01" title="Sensor is currently pressed.">MTOUCH_PRESSED</a>)   <span class="comment">// (Application Specific mode change logic)</span>
         {
             <a class="code" href="m_touch_8h.html#a5c62bf914c0353b75955a34212c1faae">mTouch_ChangeMode</a>(0);
         }
         
         PIC_SWDTEN_OFF();                 <span class="comment">// Sleep is over --&gt; let&#39;s turn off the WDT.</span>
     }
 }
 <a class="code" href="m_touch_8h.html#a84746a31eca9bfee247bb568d3903ee7" title="Enables mTouch scanning.">mTouch_EnableScanning</a>();    <span class="comment">// Re-enable scanning now that mode-changing logic is complete.</span>
</pre></div> </div>
<hr class="footer"/><address class="footer"><small>mTouch Framework v2.3 documentation by&#160;
<a href="http://www.microchip.com"> 
<img class="footer" src="../includes/mchp.jpeg" alt="Click here to visit our website at www.microchip.com"/></a></small></address> 
</body> 
</html> 
